!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define([],o):"object"==typeof exports?exports.GentooLogger=o():e.GentooLogger=o()}(self,(()=>(()=>{"use strict";var e,o,t,n,i;async function s(e,o={},t={}){const n={event:e,timestamp:Date.now(),...o,...t};console.log("sendEventLogShopify payload",n)}class r{constructor(e){null===window.__GentooLoggerInited||void 0===window.__GentooLoggerInited?(this.partnerType=e.partnerType||"shopify",this.partnerId=e.partnerId,this.authCode=e.authCode,this.udid=e.udid||"",this.displayLocation=e.displayLocation||"HOME",this.itemId=e.itemId||null,this.gentooSessionData=JSON.parse(sessionStorage.getItem("gentoo"))||{},this.chatUserId=this.gentooSessionData?.cuid||null,this.isMobileDevice=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),this.isInitialized=!1,this.categoryName=this.parseInfoFromUrl()?.categoryName,this.pageNumber=this.parseInfoFromUrl()?.pageNumber,this.searchKeyword=this.getSearchKeyword(),this.sessionId=this.gentooSessionData?.sessionId||`sess-${Date.now()}-${Math.random().toString(36).substring(2,10)}`,this.gentooSessionData?.sessionId||(this.gentooSessionData.sessionId=this.sessionId,sessionStorage.setItem("gentoo",JSON.stringify(this.gentooSessionData))),this.bootPromise=async()=>{try{try{if(!await async function(e){try{const o=await fetch(`${process.env.API_MAIN_BASE_URL}/api/shop/data/check/progress/${e}`),t=await o.json();return t.success&&t.data?"success"===t.data.status:(console.log("Training progress is not 'success'. Initialization will not proceed."),!1)}catch(e){return console.log("Training progress check failed, proceeding with initialization."),!1}}(this.partnerId))throw console.warn("GentooIO: Training not completed, skipping initialization"),window.__GentooInited="training_incomplete",new Error("Training not completed - business rule violation")}catch(e){throw console.error(`Error while calling checkTrainingProgress API: ${e}`),e}try{const e=await async function(e,o="",t,n){const i=e&&"null"!==e?String(e):Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),s={externalKey:String(t),userToken:i,udid:String(o),chatUserId:n?String(n):null};try{const e=`${process.env.API_CHAT_BASE_URL}${process.env.API_AUTH_CAFE24_ENDPOINT}`,o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return(await o.json()).chatUserId}catch(e){console.error(`Error while calling postChatUserId API: ${e}`)}}(this.authCode,this.udid,this.partnerId,this.chatUserId);if(!e)throw new Error("Failed to fetch chat user ID");this.chatUserId=e,this.gentooSessionData.cuid=e,sessionStorage.setItem("gentoo",JSON.stringify(this.gentooSessionData))}catch(e){this.chatUserId="test"}this.basicPayload={sessionId:this.sessionId,externalKey:this.partnerId,chatUserId:this.chatUserId,userToken:this.authCode,displayLocation:this.displayLocation,pageLocation:window.location.href,itemId:this.itemId,categoryName:this.categoryName,pageNumber:this.pageNumber};const e=document.referrer;return e&&!e.includes(window.location.host)?s("PageTransition",this.basicPayload,{referrerOrigin:e}):this.searchKeyword?s("PageTransition",this.basicPayload,{searchKeyword:this.searchKeyword}):s("PageTransition",this.basicPayload),window.GentooLogListener={log:e=>{"floatingEvent"===e.type&&s(e.event,this.basicPayload,{floatingMessage:e.floatingMessage}),"healthCheck"===e.type&&s(e.event,this.basicPayload,{connectionId:e.connectionId})}},(()=>{const e=function(e,o=1e3){let t=0;return(...n)=>{const i=Date.now();i-t>=o&&(t=i,e(...n))}}((()=>{const e=window.scrollY||document.documentElement.scrollTop;s("Scroll",this.basicPayload,{scrollTop:e,documentHeight:document.documentElement.scrollHeight,viewportHeight:window.innerHeight,scrollPercentage:(e/(document.documentElement.scrollHeight-window.innerHeight)*100).toFixed(1)})}));window.addEventListener("scroll",e,{passive:!0}),window.GentooCleanup=()=>{window.removeEventListener("scroll",e)}})(),Promise.resolve()}catch(e){throw console.error(`Error during initialization: ${e}`),e}},window.__GentooLoggerInited="created"):console.warn("GentooLogger already exists in the document, skipping initialization.")}async init(){if(null===window.__GentooLoggerInited||void 0===window.__GentooLoggerInited){try{if(await this.bootPromise(),this.isInitialized)return void console.warn("GentooLogger is already initialized");if(!this.chatUserId)throw new Error("Required data not yet loaded");this.isInitialized=!0}catch(e){throw console.error("Failed to initialize:",e),e}window.__GentooLoggerInited="init"}else console.warn("GentooIO init called twice, skipping second call.")}parseInfoFromUrl(e=window.location.href){const o=new URL(e),t=o.pathname;try{const e=/\/collections\/([^\/\?]+)/,n=o.searchParams.get("page")||null,i=t.match(e);return{categoryName:i?i[1]:null,pageNumber:n}}catch(e){return console.error("Invalid URL:",e),null}}getSearchKeyword(){const e=new URL(window.location.href).searchParams;return e.get("q")||e.get("query")||null}}return window.GentooLogger=r,e=window,document,i=(t=e).GentooLogger,t.GentooLogger=((n=function(){n.q.push(Array.from(arguments)),function(){for(;t.GentooLogger.q&&t.GentooLogger.q.length;){var e=t.GentooLogger.q.shift();t.GentooLogger.process(e)}}()}).q=n.q||[],n.process=function(e){var t=e[0],n=e[1]||{};if("boot"!==t)o?"init"===t?"function"==typeof o.init&&Promise.resolve(o.init(n)).catch((e=>{console.error("Failed to initialize GentooLogger:",e)})):console.error("GentooLogger: Unknown method",t):console.error("GentooLogger: Must call boot() before using this method");else try{o=new r(n)}catch(e){console.error("Failed to create GentooLogger instance:",e)}},n),i&&i.q&&i.q.forEach((function(e){t.GentooLogger.process(e)})),{}})()));