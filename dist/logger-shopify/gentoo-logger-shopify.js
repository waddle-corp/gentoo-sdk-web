!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["gentoo-logger-shopify"]=e():t["gentoo-logger-shopify"]=e()}(self,(()=>(()=>{"use strict";async function t(t,e={},o={}){const i={event:t,timestamp:Date.now(),...e,...o};navigator.sendBeacon("https://tracking.gentooai.com/api/v1/beacon/track-shopify",JSON.stringify(i))}class e{constructor(e){null===window.__GentooLoggerInited||void 0===window.__GentooLoggerInited?(this.partnerType=e.partnerType||"shopify",this.partnerId=e.partnerId,this.authCode=e.authCode,this.udid=e.udid||"",this.displayLocation=e.displayLocation||"HOME",this.itemId=e.itemId||null,this.gentooSessionData=JSON.parse(sessionStorage.getItem("gentoo"))||{},this.chatUserId=this.gentooSessionData?.cuid||null,this.isMobileDevice=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),this.isInitialized=!1,this.categoryName=this.parseInfoFromUrl()?.categoryName,this.pageNumber=this.parseInfoFromUrl()?.pageNumber,this.searchKeyword=this.getSearchKeyword(),this.sessionId=this.gentooSessionData?.sessionId||`sess-${Date.now()}-${Math.random().toString(36).substring(2,10)}`,this.gentooSessionData?.sessionId||(this.gentooSessionData.sessionId=this.sessionId,sessionStorage.setItem("gentoo",JSON.stringify(this.gentooSessionData))),this.bootPromise=async()=>{try{try{if(!await async function(t){try{const e=await fetch(`https://api.gentooai.com/app/api/shop/data/check/progress/${t}`),o=await e.json();return o.success&&o.data?"success"===o.data.status:(console.log("Training progress is not 'success'. Initialization will not proceed."),!1)}catch(t){return console.log("Training progress check failed, proceeding with initialization."),!1}}(this.partnerId))throw console.warn("GentooIO: Training not completed, skipping initialization"),window.__GentooInited="training_incomplete",new Error("Training not completed - business rule violation")}catch(t){throw console.error(`Error while calling checkTrainingProgress API: ${t}`),t}try{const t=await async function(t,e="",o,i){const n=t&&"null"!==t?String(t):Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),s={externalKey:String(o),userToken:n,udid:String(e),chatUserId:i?String(i):null};try{const t="https://api.gentooai.com/chat/api/v1/user",e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return(await e.json()).chatUserId}catch(t){console.error(`Error while calling postChatUserId API: ${t}`)}}(this.authCode,this.udid,this.partnerId,this.chatUserId);if(!t)throw new Error("Failed to fetch chat user ID");this.chatUserId=t,this.gentooSessionData.cuid=t,sessionStorage.setItem("gentoo",JSON.stringify(this.gentooSessionData))}catch(t){this.chatUserId="test"}this.basicPayload={sessionId:this.sessionId,externalKey:this.partnerId,chatUserId:this.chatUserId,userToken:this.authCode,displayLocation:this.displayLocation,pageLocation:window.location.href,itemId:this.itemId,categoryName:this.categoryName,pageNumber:this.pageNumber};const e=document.referrer;return e&&!e.includes(window.location.host)?t("PageTransition",this.basicPayload,{referrerOrigin:e}):this.searchKeyword?t("PageTransition",this.basicPayload,{searchKeyword:this.searchKeyword}):t("PageTransition",this.basicPayload),window.GentooLogListener={log:e=>{"floatingEvent"===e.type&&t(e.event,this.basicPayload,{floatingMessage:e.floatingMessage}),"healthCheck"===e.type&&t(e.event,this.basicPayload,{connectionId:e.connectionId})}},Promise.resolve()}catch(t){throw console.error(`Error during initialization: ${t}`),t}},window.__GentooLoggerInited="created"):console.warn("GentooLogger already exists in the document, skipping initialization.")}async init(){if("init"===window.__GentooLoggerInited||this.isInitialized)console.warn("GentooLogger init called twice, skipping second call.");else{try{if(await this.bootPromise(),!this.chatUserId)throw new Error("Required data not yet loaded");this.isInitialized=!0}catch(t){throw console.error("Failed to initialize:",t),t}window.__GentooLoggerInited="init"}}parseInfoFromUrl(t=window.location.href){const e=new URL(t),o=e.pathname;try{const t=/\/collections\/([^\/\?]+)/,i=e.searchParams.get("page")||null,n=o.match(t);return{categoryName:n?n[1]:null,pageNumber:i}}catch(t){return console.error("Invalid URL:",t),null}}getSearchKeyword(){const t=new URL(window.location.href).searchParams;return t.get("q")||t.get("query")||null}}var o,i,n,s,r;return o=window,document,r=(n=o).GentooLogger,n.GentooLogger=((s=function(){s.q.push(Array.from(arguments)),function(){for(;n.GentooLogger.q&&n.GentooLogger.q.length;){var t=n.GentooLogger.q.shift();n.GentooLogger.process(t)}}()}).q=s.q||[],s.process=function(t){var o=t[0],n=t[1]||{};if("boot"!==o)i?"init"===o?"function"==typeof i.init&&Promise.resolve(i.init(n)).catch((t=>{console.error("Failed to initialize GentooLogger:",t)})):console.error("GentooLogger: Unknown method",o):console.error("GentooLogger: Must call boot() before using this method");else try{i=new e(n)}catch(t){console.error("Failed to create GentooLogger instance:",t)}},s),r&&r.q&&r.q.forEach((function(t){n.GentooLogger.process(t)})),{}})()));