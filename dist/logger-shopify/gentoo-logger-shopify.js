/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(function webpackUniversalModuleDefinition(root, factory) {
	if(typeof exports === 'object' && typeof module === 'object')
		module.exports = factory();
	else if(typeof define === 'function' && define.amd)
		define([], factory);
	else if(typeof exports === 'object')
		exports["gentoo-logger-shopify"] = factory();
	else
		root["gentoo-logger-shopify"] = factory();
})(self, () => {
return /******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/apis/chatConfig.js":
/*!********************************!*\
  !*** ./src/apis/chatConfig.js ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   checkTrainingProgress: () => (/* binding */ checkTrainingProgress),\n/* harmony export */   generateGuestUserToken: () => (/* binding */ generateGuestUserToken),\n/* harmony export */   getBootConfig: () => (/* binding */ getBootConfig),\n/* harmony export */   getChatbotData: () => (/* binding */ getChatbotData),\n/* harmony export */   getFloatingData: () => (/* binding */ getFloatingData),\n/* harmony export */   getGodomallPartnerId: () => (/* binding */ getGodomallPartnerId),\n/* harmony export */   getImwebPartnerId: () => (/* binding */ getImwebPartnerId),\n/* harmony export */   getPartnerId: () => (/* binding */ getPartnerId),\n/* harmony export */   postChatEventLog: () => (/* binding */ postChatEventLog),\n/* harmony export */   postChatUserId: () => (/* binding */ postChatUserId),\n/* harmony export */   sendEventLog: () => (/* binding */ sendEventLog),\n/* harmony export */   sendEventLogShopify: () => (/* binding */ sendEventLogShopify)\n/* harmony export */ });\n// logger apis\nasync function postChatUserId(userToken, udid = \"\", partnerId, chatUserId) {\n    const convertedUserToken = (userToken && userToken !== 'null') ? String(userToken) : Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);\n    const params = {\n        externalKey: String(partnerId),\n        userToken: convertedUserToken,\n        udid: String(udid),\n        chatUserId: chatUserId ? String(chatUserId) : null\n    }\n\n    try {\n        const url = `${\"https://dev-api.gentooai.com/chat\"}${\"/api/v1/user\"}`;\n        const response = await fetch(url, {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify(params)\n        });\n\n        const res = await response.json();\n        // console.log('postChatUserId res.chatUserId', res.chatUserId);\n        return res.chatUserId;\n    } catch (error) {\n        console.error(`Error while calling postChatUserId API: ${error}`)\n    }\n}\n\nasync function sendEventLog(event, basicPayload = {}, customPayload = {}) {\n    // if (!customPayload.referrerOrigin) return;\n    \n    const payload = {\n        event,\n        timestamp: Date.now(),\n        ...basicPayload,\n        ...customPayload,\n    }\n\n    const url = `${\"https://dev-tracking.gentooai.com\"}${\"/api/v1/beacon/track\"}`;\n    navigator.sendBeacon(\n        url,\n        JSON.stringify(payload)\n    );\n}\n\nasync function sendEventLogShopify(event, basicPayload = {}, customPayload = {}) {\n    // if (!customPayload.referrerOrigin) return;\n    \n    const payload = {\n        event,\n        timestamp: Date.now(),\n        ...basicPayload,\n        ...customPayload,\n    }\n\n    const url = `${\"https://dev-tracking.gentooai.com\"}/api/v1/beacon/track-shopify`;\n    navigator.sendBeacon(\n        url,\n        JSON.stringify(payload)\n    );\n}\n\n// floating button apis\nasync function getChatbotData(partnerId, chatUserId) {\n    try {\n        const response = await fetch(`${\"https://dev-api.gentooai.com/chat\"}${\"/api/v1/chat/chatbot\"}/${partnerId}?chatUserId=${chatUserId}`, {\n            method: \"GET\",\n            headers: {},\n        });\n        const res = await response.json();\n        return res;\n    } catch (error) {\n        console.error(`Error while calling getChatbotData API: ${error}`);\n    }\n}\n\nasync function getFloatingData(partnerId, displayLocation, itemId, chatUserId) {\n    try {\n        const response = await fetch(\n            `${\"https://dev-api.gentooai.com/chat\"}${\"/api/v1/chat/floating\"}/${partnerId}?displayLocation=${displayLocation}&itemId=${itemId}&chatUserId=${chatUserId}`,\n            {\n                method: \"GET\",\n                headers: {},\n            }\n        );\n\n        const res = await response.json();\n        return res;\n    } catch (error) {\n        console.error(`Error while calling getFloatingData API: ${error}`);\n    }\n}\n\nasync function getPartnerId(mallId) {\n    try {\n        const url = `${\"https://dev-api.gentooai.com/app\"}${\"/api/partner/v1/cafe24/mall\"}/${mallId}`;\n        const response = await fetch(url, {\n            method: \"GET\",\n            headers: {}\n        });\n        const res = await response.json();\n        return res.partnerId;\n    } catch (error) {\n        console.error(`Error while calling getPartnerId API: ${error}`)\n    }\n}\n\nasync function getGodomallPartnerId(mallId) {\n    try {\n        const url = `${\"https://dev-api.gentooai.com/app\"}${\"/api/partner/v1/godomall/mall\"}/${mallId}`;\n        const response = await fetch(url, {\n            method: \"GET\",\n            headers: {}\n        });\n        const res = await response.json();\n        return res.partnerId;\n    } catch (error) {\n        console.error(`Error while calling getGodomallPartnerId API: ${error}`)\n    }\n}\n\nasync function postChatEventLog(payload, isMobileDevice) {\n    try {\n        const params = {\n            eventCategory: String(payload.eventCategory),\n            chatUserId: String(payload.chatUserId),\n            partnerId: String(payload.partnerId),\n            channelId: isMobileDevice ? \"mobile\" : \"web\",\n            products: payload?.products,\n        };\n\n        const response = await fetch(`${\"https://dev-api.gentooai.com/chat\"}${\"/api/v1/event/userEvent\"}/${payload.partnerId}`, {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify(params),\n        });\n\n        const res = await response.json(); // JSON 형태의 응답 데이터 파싱\n        return res;\n    } catch (error) {\n        console.error(`Error while calling logEvent API: ${error}`);\n    }\n}\n\nasync function getBootConfig(chatUserId, currentUrl, displayLocation, itemId, partnerId) {\n    try {\n        const response = await fetch(`${\"https://dev-api.gentooai.com/chat\"}${\"/api/sdk/boot\"}?chatUserId=${chatUserId}&url=${currentUrl}&displayLocation=${displayLocation}&itemId=${itemId}`, {\n            method: \"GET\",\n            headers: {\n                Authorization: `Bearer ${partnerId}`,\n            }\n        });\n        const res = await response.json();\n        return res;\n    } catch (error) {\n        console.error(`Error while calling getBootConfig API: ${error}`);\n    }\n}\n\n// imweb api\nasync function getImwebPartnerId(mallId) {\n    try {\n        const url = `${\"https://dev-api.gentooai.com/app\"}${process.env.API_IMWEB_PARTNERID_ENDPOINT}/${mallId}`;\n        const response = await fetch(url, {\n            method: \"GET\",\n            headers: {}\n        });\n        const res = await response.json();\n        return res.partnerId;\n    } catch (error) {\n        console.error(`Error while calling getImwebPartnerId API: ${error}`)\n    }\n}\n\nfunction generateGuestUserToken(length = 16) {\n    return 'guest' + Math.random().toString(36).substring(2, length);\n}\n\n// shopify\nasync function checkTrainingProgress(partnerId) {\n\n    try {\n        const response = await fetch(`${\"https://dev-api.gentooai.com/app\"}/api/shop/data/check/progress/${partnerId}`);\n        const data = await response.json();\n\n        if (data.success && data.data) {\n            return data.data.status === 'success';\n        }\n\n        console.log(\"Training progress is not 'success'. Initialization will not proceed.\");\n        return false;\n    } catch (error) {\n        console.log(\"Training progress check failed, proceeding with initialization.\");\n        return false;\n    }\n}\n\n//# sourceURL=webpack://gentoo-logger-shopify/./src/apis/chatConfig.js?");

/***/ }),

/***/ "./src/logger-shopify.js":
/*!*******************************!*\
  !*** ./src/logger-shopify.js ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./apis/chatConfig */ \"./src/apis/chatConfig.js\");\n\n\nclass Logger {\n    constructor(props) {\n        // Check for existing SDK elements \n        if (window.__GentooLoggerInited !== null && window.__GentooLoggerInited !== undefined) {\n            console.warn(\"GentooLogger already exists in the document, skipping initialization.\");\n            return;\n        }\n\n        this.partnerType = props.partnerType || 'shopify';\n        this.partnerId = props.partnerId;\n        this.authCode = props.authCode;\n        this.udid = props.udid || \"\";\n        this.displayLocation = props.displayLocation || \"HOME\";\n        this.itemId = props.itemId || null;\n        this.gentooSessionData = JSON.parse(sessionStorage.getItem('gentoo')) || {};\n        this.chatUserId = this.gentooSessionData?.cuid || null;\n        this.isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);\n        this.isInitialized = false;  // Add flag to track initialization\n        this.categoryName = this.parseInfoFromUrl()?.categoryName;\n        this.pageNumber = this.parseInfoFromUrl()?.pageNumber;\n        this.searchKeyword = this.getSearchKeyword();\n        this.sessionId = this.gentooSessionData?.sessionId || `sess-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;\n        if (!this.gentooSessionData?.sessionId) {\n            this.gentooSessionData.sessionId = this.sessionId;\n            sessionStorage.setItem('gentoo', JSON.stringify(this.gentooSessionData));\n        }\n\n        this.bootPromise = async () => {\n\n            try {\n                try {\n                    const canProceed = await (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.checkTrainingProgress)(this.partnerId);\n                    if (!canProceed) {\n                        console.warn(\"GentooIO: Training not completed, skipping initialization\");\n                        window.__GentooInited = 'training_incomplete';\n                        throw new Error(\"Training not completed - business rule violation\");\n                    }\n                } catch (error) {\n                    console.error(`Error while calling checkTrainingProgress API: ${error}`);\n                    throw error;\n                }\n\n                try {\n                    const chatUserId = await (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.postChatUserId)(this.authCode, this.udid, this.partnerId, this.chatUserId);\n                    if (!chatUserId) throw new Error(\"Failed to fetch chat user ID\");\n                    this.chatUserId = chatUserId;\n                    this.gentooSessionData.cuid = chatUserId;\n                    sessionStorage.setItem('gentoo', JSON.stringify(this.gentooSessionData));\n                } catch (error) {\n                    this.chatUserId = 'test';\n                }\n\n                // declare basic payload\n                this.basicPayload = {\n                    sessionId: this.sessionId,\n                    externalKey: this.partnerId,\n                    chatUserId: this.chatUserId,\n                    userToken: this.authCode,\n                    displayLocation: this.displayLocation,\n                    pageLocation: window.location.href,\n                    itemId: this.itemId,\n                    categoryName: this.categoryName, \n                    pageNumber: this.pageNumber,\n                }\n\n                // send event log\n                const ref = document.referrer;\n                if (ref && !ref.includes(window.location.host)) {\n                    (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.sendEventLogShopify)(\"PageTransition\", this.basicPayload, { referrerOrigin: ref });\n                } else if (this.searchKeyword) {\n                    (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.sendEventLogShopify)(\"PageTransition\", this.basicPayload, { searchKeyword: this.searchKeyword });\n                } else {\n                    (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.sendEventLogShopify)(\"PageTransition\", this.basicPayload); \n                }\n\n                window.GentooLogListener = {\n                    log: (payload) => {\n                        if (payload.type === 'floatingEvent') {\n                            (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.sendEventLogShopify)(payload.event, this.basicPayload, { floatingMessage: payload.floatingMessage });\n                        }\n                        if (payload.type === 'healthCheck') {\n                            (0,_apis_chatConfig__WEBPACK_IMPORTED_MODULE_0__.sendEventLogShopify)(payload.event, this.basicPayload, { connectionId: payload.connectionId });\n                        }\n                    }\n                }\n\n                /* const attachScrollTracker = () => {\n                    // 간단한 throttle 유틸 – 1초당 한 번만 실행 \n                    function throttle(fn, wait = 1000) {\n                        let last = 0;\n                        return (...args) => {\n                            const now = Date.now();\n                            if (now - last >= wait) {\n                                last = now;\n                                fn(...args);\n                            }\n                        };\n                    }\n    \n                    // 실제 스크롤 핸들러 \n                    const onScroll = throttle(() => {\n                        const y = window.scrollY || document.documentElement.scrollTop;\n                        sendEventLogShopify(\"Scroll\", this.basicPayload, {\n                            scrollTop: y,\n                            documentHeight: document.documentElement.scrollHeight,\n                            viewportHeight: window.innerHeight,\n                            scrollPercentage: (y / (document.documentElement.scrollHeight - window.innerHeight) * 100).toFixed(1),\n                        });\n                    });\n    \n                    // passive:true → 스크롤 성능 보호 \n                    window.addEventListener('scroll', onScroll, { passive: true });\n    \n                    // SDK가 언마운트될 때 정리(선택) \n                    window.GentooCleanup = () => {\n                        window.removeEventListener('scroll', onScroll);\n                    };\n                };\n                attachScrollTracker(); */\n\n                return Promise.resolve();\n            } catch (error) {\n                console.error(`Error during initialization: ${error}`);\n                throw error;\n            }\n        };\n        window.__GentooLoggerInited = 'created';\n    }\n\n    async init() {\n        if (window.__GentooLoggerInited === 'init' || this.isInitialized) {\n            console.warn(\"GentooLogger init called twice, skipping second call.\");\n            return;\n        }\n\n        try {\n            // Wait for boot process to complete\n            await this.bootPromise();\n\n            if (!this.chatUserId) {\n                throw new Error('Required data not yet loaded');\n            }\n\n            this.isInitialized = true;\n\n        } catch (error) {\n            console.error('Failed to initialize:', error);\n            throw error;\n        }\n\n        window.__GentooLoggerInited = 'init';\n    }\n\n    /**\n     * 현재 URL 또는 주어진 URL에서 product_no 값을 추출하는 함수\n     * \n     * @param {string} [urlString=window.location.href] - 분석할 URL 문자열\n     * @returns {string|null} - 추출된 product_no 값 또는 null (찾을 수 없을 경우)\n     */\n    parseInfoFromUrl(urlString = window.location.href) {\n        const url = new URL(urlString);\n        const path = url.pathname;\n\n        try {\n            // URL 객체 생성\n            // const url = new URL(urlString);\n\n            /* // 1. 쿼리 파라미터에서 product_no 추출 시도\n            const productNoFromQuery = url.searchParams.get('product_no');\n            if (productNoFromQuery) {\n                return productNoFromQuery;\n            } */\n\n            // 2. 경로 기반 URL에서 product_no 추출 시도\n            // const path = url.pathname;\n\n            /**\n             * 고려가 필요한 cafe24 경로 패턴\n                /product/{product_name}/{product_no}\n                /product/{product_name}/{product_no}/category/{category_no}/display/{display_group_no}\n                /{shop_no}/product/{product_name}/{product_no}\n             */\n\n            /**\n             * 정규 표현식 설명:\n                (?:\\/[^\\/]+)?\t🔹 optional shop_no segment (/12345 등)\n                \\/product\\/\t/product/ 고정\n                [^\\/]+\tproduct_name\n                \\/([^\\/]+)\t✅ 캡처할 product_no\n                (?:\\/category/...)?\t🔹 optional category/display path\n             */\n            //const regexProductNo = /^(?:\\/[^\\/]+)?\\/product\\/[^\\/]+\\/([^\\/]+)(?:\\/category\\/[^\\/]+\\/display\\/[^\\/]+\\/?)?$/;\n            //const regexCategoryNo = /(?:\\/category\\/(?:[^\\/]+\\/)*|[?&]cate_no=)(\\d+)/;\n            const regexCategoryName = /\\/collections\\/([^\\/\\?]+)/;\n            const searchParams = url.searchParams;\n            const pageNumber = searchParams.get('page') || null;\n            //const matchProductNo = path.match(regexProductNo);\n            //const matchCategoryNo = path.match(regexCategoryNo);\n            const matchCategoryName = path.match(regexCategoryName);\n\n            // 3. 찾을 수 없는 경우 null 반환\n            return {\n                //productNo: matchProductNo ? matchProductNo[1] : null,\n                //categoryNo: matchCategoryNo ? matchCategoryNo[1] : null,\n                categoryName: matchCategoryName ? matchCategoryName[1] : null,\n                pageNumber: pageNumber,\n            };\n        } catch (error) {\n            console.error('Invalid URL:', error);\n            return null;\n        }\n    }\n\n    getSearchKeyword() {\n        const url = new URL(window.location.href);\n        const searchParams = url.searchParams;\n        return searchParams.get('q') || searchParams.get('query') || null;\n    }\n}\n\n// Initialize queue processor immediately to avoid timing issues\n(function (global, document) {\n    var w = global;\n\n    var logger; // Keep logger in closure scope\n\n    // Create a persistent queue processor\n    function createQueueProcessor() {\n        var ge = function () {\n            ge.q.push(Array.from(arguments));\n            processQueue();\n        };\n\n        // Initialize queue\n        ge.q = ge.q || [];\n\n        ge.process = function (args) {\n            var method = args[0];\n            var params = args[1] || {};\n\n            // Handle boot separately\n            if (method === \"boot\") {\n                try {\n                    logger = new Logger(params);\n                } catch (error) {\n                    console.error(\"Failed to create GentooLogger instance:\", error);\n                }\n                return;\n            }\n\n            // For all other methods, ensure instance exists\n            if (!logger) {\n                console.error(\"GentooLogger: Must call boot() before using this method\");\n                return;\n            }\n\n            // Process method\n            switch (method) {\n                case \"init\":\n                    if (typeof logger.init === \"function\") {\n                        Promise.resolve(logger.init(params)).catch((error) => {\n                            console.error(\"Failed to initialize GentooLogger:\", error);\n                        });\n                    }\n                    break;\n                default:\n                    console.error(\"GentooLogger: Unknown method\", method);\n            }\n        };\n\n        return ge;\n    }\n\n    function processQueue() {\n        while (w.GentooLogger.q && w.GentooLogger.q.length) {\n            var args = w.GentooLogger.q.shift();\n            w.GentooLogger.process(args);\n        }\n    }\n\n    // Initialize or get existing GentooLogger\n    var existingGentooLogger = w.GentooLogger;\n    w.GentooLogger = createQueueProcessor();\n\n    // Process any existing queue items\n    if (existingGentooLogger && existingGentooLogger.q) {\n        existingGentooLogger.q.forEach(function (args) {\n            w.GentooLogger.process(args);\n        });\n    }\n})(window, document);\n\n\n//# sourceURL=webpack://gentoo-logger-shopify/./src/logger-shopify.js?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/logger-shopify.js");
/******/ 	
/******/ 	return __webpack_exports__;
/******/ })()
;
});